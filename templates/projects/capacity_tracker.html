{% extends "base.html" %}

{% block title %}Recruitment Capacity Tracker - Newton's Repository{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero hero-sm">
    <div class="container">
        <h1 class="fw-bold mb-2">Recruitment Capacity Tracker</h1>
        <p class="mb-0 opacity-75">Calculate team capacity with advanced workload analysis</p>
    </div>
</section>

<div class="container py-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('home') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('projects') }}">Projects</a></li>
            <li class="breadcrumb-item active" aria-current="page">Capacity Tracker</li>
        </ol>
    </nav>

    <!-- Tool Description -->
    <div class="row mb-5">
        <div class="col-lg-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <h2 class="h5 mb-3">About This Tool</h2>
                    <p class="mb-2">
                        This enhanced tool calculates recruitment team capacity with advanced business logic including internal role discounts and stage-based time weighting.
                    </p>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fw-semibold">Base Capacity Rules:</h6>
                            <ul class="small mb-3">
                                <li><strong>Easy:</strong> Max 30 at full capacity (3.33% each)</li>
                                <li><strong>Medium:</strong> Max 20 at full capacity (5% each)</li>
                                <li><strong>Hard:</strong> Max 12 at full capacity (8.33% each)</li>
                                <li><strong>Internal roles:</strong> 75% less time (0.25 multiplier)</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-semibold">Stage-Based Time Weighting:</h6>
                            <ul class="small mb-3">
                                <li>Sourcing: 20% | Screening: 40%</li>
                                <li>Interview: 20% | Offer: 10%</li>
                                <li>Pre-Hire Checks: 10%</li>
                                <li>No stage specified: 100%</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Messages -->
    {% if errors %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong><i class="bi bi-exclamation-triangle-fill"></i> Please correct the following errors:</strong>
        <ul class="mb-0 mt-2">
            {% for error in errors %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- Input Method Tabs -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <ul class="nav nav-tabs card-header-tabs" id="inputMethodTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="excel-tab" data-bs-toggle="tab" data-bs-target="#excel-upload" type="button" role="tab" aria-controls="excel-upload" aria-selected="true">
                                <i class="bi bi-file-earmark-excel"></i> Excel Upload
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-input" type="button" role="tab" aria-controls="manual-input" aria-selected="false">
                                <i class="bi bi-pencil-square"></i> Manual Input
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body p-4">
                    <div class="tab-content" id="inputMethodTabContent">
                        <!-- Excel Upload Tab -->
                        <div class="tab-pane fade show active" id="excel-upload" role="tabpanel" aria-labelledby="excel-tab">
                            <div class="row">
                                <div class="col-lg-8">
                                    <h5 class="mb-3">Upload Excel File</h5>
                                    <p class="text-muted mb-3">
                                        Upload an Excel file with your team's vacancy data. Download our template to see the required format.
                                    </p>

                                    <form method="POST" enctype="multipart/form-data" id="excelUploadForm">
                                        <div class="mb-4">
                                            <label for="excelFile" class="form-label fw-semibold">Choose Excel File (.xlsx or .xls)</label>
                                            <input type="file" class="form-control" id="excelFile" name="excel_file" accept=".xlsx,.xls" required>
                                            <div class="form-text">Maximum file size: 10MB</div>
                                        </div>

                                        <div class="d-grid gap-2 d-md-flex">
                                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                                <i class="bi bi-upload"></i> Upload & Calculate
                                            </button>
                                            <a href="{{ url_for('download_capacity_template') }}" class="btn btn-outline-secondary btn-lg">
                                                <i class="bi bi-download"></i> Download Template
                                            </a>
                                        </div>
                                    </form>
                                </div>
                                <div class="col-lg-4">
                                    <div class="bg-light p-3 rounded">
                                        <h6 class="fw-semibold mb-2">Required Columns:</h6>
                                        <ol class="small mb-0">
                                            <li>Vacancy Name</li>
                                            <li>Recruiter Name</li>
                                            <li>Role Type (Easy/Medium/Hard)</li>
                                            <li>Internal? (Yes/No)</li>
                                            <li>Stage (or blank)</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Manual Input Tab -->
                        <div class="tab-pane fade" id="manual-input" role="tabpanel" aria-labelledby="manual-tab">
                            <h5 class="mb-3">Manual Entry</h5>
                            <p class="text-muted mb-4">
                                Add individual vacancies with detailed information. Click "Add Another Vacancy" to build your team's workload.
                            </p>

                            <form method="POST" id="manualInputForm">
                                <div id="vacancyInputs">
                                    <!-- Initial vacancy input row -->
                                    <div class="vacancy-row mb-4 pb-4 border-bottom" data-index="0">
                                        <div class="row g-3">
                                            <div class="col-md-3">
                                                <label class="form-label fw-semibold">Recruiter Name *</label>
                                                <input type="text" class="form-control" name="recruiter_0" required
                                                       placeholder="e.g., John Smith">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label fw-semibold">Vacancy Name</label>
                                                <input type="text" class="form-control" name="vacancy_name_0"
                                                       placeholder="e.g., Senior Developer">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label fw-semibold">Role Type *</label>
                                                <select class="form-select" name="role_type_0" required>
                                                    <option value="easy">Easy</option>
                                                    <option value="medium">Medium</option>
                                                    <option value="hard">Hard</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label fw-semibold">Internal? *</label>
                                                <select class="form-select" name="internal_0">
                                                    <option value="no">No</option>
                                                    <option value="yes">Yes</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label fw-semibold">Stage</label>
                                                <select class="form-select" name="stage_0">
                                                    <option value="">None</option>
                                                    <option value="sourcing">Sourcing</option>
                                                    <option value="screening">Screening</option>
                                                    <option value="interview">Interview</option>
                                                    <option value="offer">Offer</option>
                                                    <option value="pre-hire checks">Pre-Hire Checks</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Add Vacancy Button -->
                                <div class="mb-4">
                                    <button type="button" class="btn btn-outline-primary" id="addVacancyBtn">
                                        <i class="bi bi-plus-circle"></i> Add Another Vacancy
                                    </button>
                                </div>

                                <!-- Submit Button -->
                                <div class="d-grid gap-2 d-md-flex">
                                    <button type="submit" class="btn btn-primary btn-lg px-5">
                                        <i class="bi bi-calculator"></i> Calculate Capacity
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-lg" id="resetBtn">
                                        <i class="bi bi-arrow-counterclockwise"></i> Reset Form
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    {% if recruiters %}
    <div class="row mb-5">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                    <h3 class="h5 mb-0 py-2">
                        <i class="bi bi-graph-up"></i> Capacity Results
                        {% if input_method == 'excel' %}
                        <span class="badge bg-primary ms-2">Excel Upload</span>
                        {% elif input_method == 'manual' %}
                        <span class="badge bg-success ms-2">Manual Entry</span>
                        {% endif %}
                    </h3>
                </div>
                <div class="card-body p-0">
                    <!-- Recruiters List -->
                    <div class="accordion accordion-flush" id="recruitersAccordion">
                        {% for recruiter in recruiters %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading{{ loop.index }}">
                                <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}"
                                        aria-expanded="{% if loop.first %}true{% else %}false{% endif %}"
                                        aria-controls="collapse{{ loop.index }}">
                                    <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                        <div>
                                            <strong>{{ recruiter.name }}</strong>
                                            <span class="badge capacity-badge capacity-{{ recruiter.status }} ms-2">
                                                {{ recruiter.status_text }}
                                            </span>
                                        </div>
                                        <div class="text-end">
                                            <span class="h5 mb-0 fw-bold">{{ recruiter.capacity_percentage }}%</span>
                                            <span class="text-muted ms-2 small">
                                                ({{ recruiter.vacancies|length }} {% if recruiter.vacancies|length == 1 %}vacancy{% else %}vacancies{% endif %})
                                            </span>
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="collapse{{ loop.index }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
                                 aria-labelledby="heading{{ loop.index }}" data-bs-parent="#recruitersAccordion">
                                <div class="accordion-body">
                                    <!-- Vacancy Details Table -->
                                    <div class="table-responsive mb-3">
                                        <table class="table table-sm table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Vacancy</th>
                                                    <th class="text-center">Type</th>
                                                    <th class="text-center">Internal?</th>
                                                    <th class="text-center">Stage</th>
                                                    <th class="text-end">Capacity</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for vacancy in recruiter.vacancies %}
                                                <tr>
                                                    <td>{{ vacancy.name }}</td>
                                                    <td class="text-center">
                                                        <span class="badge bg-secondary">{{ vacancy.role_type }}</span>
                                                    </td>
                                                    <td class="text-center">
                                                        {% if vacancy.is_internal %}
                                                        <span class="badge bg-info">Yes</span>
                                                        {% else %}
                                                        <span class="badge bg-light text-dark">No</span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-center small">
                                                        {% if vacancy.stage and vacancy.stage != 'None' %}
                                                        {{ vacancy.stage|capitalize }}
                                                        {% else %}
                                                        <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-end fw-semibold">{{ vacancy.capacity_percentage }}%</td>
                                                </tr>
                                                {% endfor %}
                                                <tr class="table-active">
                                                    <td colspan="4" class="text-end fw-bold">Total Capacity:</td>
                                                    <td class="text-end fw-bold">{{ recruiter.capacity_percentage }}%</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Remaining Capacity -->
                                    <div class="alert alert-{{ 'danger' if recruiter.capacity_used > 1.0 else 'info' }} mb-0">
                                        <small><i class="bi bi-info-circle"></i> {{ recruiter.remaining_message }}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Summary -->
    {% if team_summary %}
    <div class="row mb-5">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h3 class="h5 mb-0 py-2"><i class="bi bi-people-fill"></i> Team Summary</h3>
                </div>
                <div class="card-body p-4">
                    <div class="row g-4 text-center">
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded">
                                <div class="h2 mb-1 fw-bold text-primary">{{ team_summary.total_recruiters }}</div>
                                <div class="small text-muted">Team Members</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded">
                                <div class="h2 mb-1 fw-bold text-primary">{{ team_summary.average_capacity }}%</div>
                                <div class="small text-muted">Average Capacity</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 rounded team-health-{{ team_summary.team_health }}">
                                <div class="h5 mb-1 fw-bold">{{ team_summary.team_health_text }}</div>
                                <div class="small">
                                    <span class="badge bg-success me-1">{{ team_summary.status_counts.available }}</span> Available |
                                    <span class="badge bg-warning text-dark me-1">{{ team_summary.status_counts['near-capacity'] }}</span> Near Capacity |
                                    <span class="badge bg-danger me-1">{{ team_summary.status_counts['at-capacity'] }}</span> At Capacity |
                                    <span class="badge bg-dark">{{ team_summary.status_counts.overloaded }}</span> Overloaded
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- Back to Projects -->
    <div class="mt-5 pt-3 border-top">
        <a href="{{ url_for('projects') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Projects
        </a>
    </div>
</div>

<!-- Custom Styles -->
<style>
    /* Capacity Status Badges */
    .capacity-badge {
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
        font-weight: 600;
        border-radius: 6px;
        display: inline-block;
        min-width: 100px;
    }

    .capacity-available {
        background-color: #28a745;
        color: white;
    }

    .capacity-near-capacity {
        background-color: #ffc107;
        color: #333;
    }

    .capacity-at-capacity {
        background-color: #dc3545;
        color: white;
    }

    .capacity-overloaded {
        background-color: #8b0000;
        color: white;
    }

    /* Team Health Indicators */
    .team-health-healthy {
        background-color: #d4edda;
        border: 2px solid #28a745;
    }

    .team-health-underutilized {
        background-color: #d1ecf1;
        border: 2px solid #17a2b8;
    }

    .team-health-warning {
        background-color: #fff3cd;
        border: 2px solid #ffc107;
    }

    .team-health-critical {
        background-color: #f8d7da;
        border: 2px solid #dc3545;
    }

    /* Form styling */
    .vacancy-row:last-child {
        border-bottom: none !important;
    }

    /* Accordion enhancements */
    .accordion-button:not(.collapsed) {
        background-color: #f8f9fa;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .capacity-badge {
            font-size: 0.75rem;
            min-width: 80px;
            padding: 0.4rem 0.5rem;
        }
    }
</style>

<!-- JavaScript for Dynamic Form -->
<script>
    let vacancyCount = 1;

    // Add new vacancy row
    document.getElementById('addVacancyBtn').addEventListener('click', function() {
        const container = document.getElementById('vacancyInputs');
        const newRow = document.createElement('div');
        newRow.className = 'vacancy-row mb-4 pb-4 border-bottom';
        newRow.setAttribute('data-index', vacancyCount);

        newRow.innerHTML = `
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Recruiter Name *</label>
                    <input type="text" class="form-control" name="recruiter_${vacancyCount}" required
                           placeholder="e.g., John Smith">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Vacancy Name</label>
                    <input type="text" class="form-control" name="vacancy_name_${vacancyCount}"
                           placeholder="e.g., Marketing Lead">
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Role Type *</label>
                    <select class="form-select" name="role_type_${vacancyCount}" required>
                        <option value="easy">Easy</option>
                        <option value="medium">Medium</option>
                        <option value="hard">Hard</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Internal? *</label>
                    <select class="form-select" name="internal_${vacancyCount}">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Stage</label>
                    <select class="form-select" name="stage_${vacancyCount}">
                        <option value="">None</option>
                        <option value="sourcing">Sourcing</option>
                        <option value="screening">Screening</option>
                        <option value="interview">Interview</option>
                        <option value="offer">Offer</option>
                        <option value="pre-hire checks">Pre-Hire Checks</option>
                    </select>
                </div>
            </div>
            <div class="mt-2">
                <button type="button" class="btn btn-sm btn-outline-danger remove-vacancy-btn">
                    <i class="bi bi-trash"></i> Remove
                </button>
            </div>
        `;

        container.appendChild(newRow);
        vacancyCount++;

        // Add event listener to remove button
        newRow.querySelector('.remove-vacancy-btn').addEventListener('click', function() {
            newRow.remove();
        });
    });

    // Reset form
    document.getElementById('resetBtn').addEventListener('click', function() {
        if (confirm('Are you sure you want to reset the form? All entered data will be lost.')) {
            location.reload();
        }
    });

    // Form validation
    document.getElementById('manualInputForm').addEventListener('submit', function(e) {
        const inputs = document.querySelectorAll('input[type="text"][name^="recruiter_"]');
        let hasValidInput = false;

        inputs.forEach(function(input) {
            if (input.value.trim() !== '') {
                hasValidInput = true;
            }
        });

        if (!hasValidInput) {
            e.preventDefault();
            alert('Please add at least one vacancy with a recruiter name.');
        }
    });

    // File upload validation
    document.getElementById('excelUploadForm')?.addEventListener('submit', function(e) {
        const fileInput = document.getElementById('excelFile');
        if (!fileInput.files.length) {
            e.preventDefault();
            alert('Please select an Excel file to upload.');
        }
    });
</script>
{% endblock %}
