{% extends "base.html" %}

{% block title %}Squad Audit Tracker - Newton's Repository{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero hero-sm">
    <div class="container">
        <h1 class="fw-bold mb-2">Squad Audit Tracker</h1>
        <p class="mb-0 opacity-75">Analyze Football Manager squads with per-90 performance metrics and value scoring</p>
    </div>
</section>

<div class="container py-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.home') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('projects.projects_home') }}">Projects</a></li>
            <li class="breadcrumb-item active" aria-current="page">Squad Audit Tracker</li>
        </ol>
    </nav>

    <!-- Tool Description -->
    <div class="row mb-5">
        <div class="col-lg-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <h2 class="h5 mb-3">About This Tool</h2>
                    <p class="mb-2">
                        Advanced Football Manager squad analysis that uses per-90 minute metrics to identify
                        underutilized elite performers and overvalued assets.
                    </p>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fw-semibold">Key Insights:</h6>
                            <ul class="small mb-3">
                                <li><strong>Per-90 Analysis:</strong> Find elite performers with limited minutes</li>
                                <li><strong>Value Scoring:</strong> Performance relative to wages</li>
                                <li><strong>Position-Specific:</strong> 8 position categories with tailored metrics</li>
                                <li><strong>Status-Aware:</strong> Intelligent recommendations based on flags</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-semibold">Export Your Squad Data:</h6>
                            <ul class="small mb-3">
                                <li><strong>Step 1:</strong> <a
                                        href="{{ url_for('static', filename='Squad Audit View.FMF') }}" download
                                        class="fw-bold text-decoration-underline">Download Squad Audit View.FMF</a></li>
                                <li><strong>Step 2:</strong> Import view in FM (Documents/SI/FM 2024/views/squad)</li>
                                <li><strong>Step 3:</strong> Load view in Squad screen</li>
                                <li><strong>Step 4:</strong> Right-click headers ‚Üí <strong>Export</strong> ‚Üí <strong>Web
                                        Page</strong></li>
                                <li><strong>Step 5:</strong> Upload the HTML file below</li>
                            </ul>
                            <p class="small text-muted mb-0 mt-2">
                                <i class="bi bi-lightbulb"></i> <strong>New to this?</strong>
                                <a href="{{ url_for('static', filename='Example Squad - Preston 27-28.html') }}" download
                                   class="text-decoration-underline">Download an example squad file</a> to try it out.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Messages -->
    {% if errors %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong><i class="bi bi-exclamation-triangle-fill"></i> Error processing file:</strong>
        <ul class="mb-0 mt-2">
            {% for error in errors %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    {% if not analysis_result %}
    <!-- Upload Form -->
    <div class="row mb-5">
        <div class="col-lg-8 mx-auto">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <h5 class="mb-3">Upload FM Squad Export</h5>
                    <p class="text-muted mb-4">
                        Upload your Football Manager squad export HTML file for analysis. The tool will parse player
                        statistics and generate comprehensive insights.
                    </p>

                    <form method="POST" enctype="multipart/form-data" id="squadUploadForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

                        <div class="mb-4">
                            <label for="htmlFile" class="form-label fw-semibold">Choose HTML File</label>
                            <input type="file" class="form-control form-control-lg" id="htmlFile" name="html_file"
                                accept=".html" required>
                            <div class="form-text">Export from FM Squad View ‚Üí Right-click headers ‚Üí Export ‚Üí Web Page
                                (.html)</div>
                        </div>

                        <div class="mb-4">
                            <label for="division" class="form-label fw-semibold">
                                Select Division for League Comparison
                                <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip"
                                   title="Compare player wages against league averages for this division"></i>
                            </label>
                            <select class="form-select" id="division" name="division">
                                <option value="">No league comparison</option>
                                {% if grouped_divisions %}
                                    {% for country, divisions in grouped_divisions.items() %}
                                    <optgroup label="üè¥ {{ country }}">
                                        {% for div_name, is_low_sample in divisions %}
                                        <option value="{{ div_name }}">{{ div_name }}{% if is_low_sample %} ‚ö†Ô∏è{% endif %}</option>
                                        {% endfor %}
                                    </optgroup>
                                    {% endfor %}
                                {% endif %}
                            </select>
                            <div class="form-text">Optional - enables league-based value scoring</div>
                            {% if league_baselines %}
                            <div id="division-sample-warning" class="alert alert-warning mt-2" style="display: none;">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>Low Sample Size:</strong> This division has fewer than 100 players in the dataset.
                                League averages may not be representative.
                            </div>
                            <script>
                                document.getElementById('division').addEventListener('change', function() {
                                    const warning = document.getElementById('division-sample-warning');
                                    const selectedDiv = this.options[this.selectedIndex].text;
                                    if (selectedDiv.includes('‚ö†Ô∏è')) {
                                        warning.style.display = 'block';
                                    } else {
                                        warning.style.display = 'none';
                                    }
                                });
                            </script>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label for="game_season" class="form-label fw-semibold">
                                Current In-Game Season
                                <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip"
                                   title="Your FM save's current season - used to calculate contract expiry times accurately"></i>
                            </label>
                            <select class="form-select" id="game_season" name="game_season">
                                <option value="">Use real-world date</option>
                                <option value="2024">2024/25</option>
                                <option value="2025">2025/26</option>
                                <option value="2026">2026/27</option>
                                <option value="2027">2027/28</option>
                                <option value="2028">2028/29</option>
                                <option value="2029">2029/30</option>
                                <option value="2030">2030/31</option>
                                <option value="2031">2031/32</option>
                                <option value="2032">2032/33</option>
                                <option value="2033">2033/34</option>
                                <option value="2034">2034/35</option>
                                <option value="2035">2035/36</option>
                            </select>
                            <div class="form-text">Set your save's season for accurate contract expiry calculations</div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-upload"></i> Analyze Squad
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if analysis_result %}
    <!-- Hidden CSRF token for AJAX calls -->
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

    <!-- Analysis Results -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom py-3">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h4 class="mb-0">Squad Analysis Results</h4>
                            <p class="text-muted mb-0 small">
                                {{ analysis_result.total_players }} players analyzed |
                                Average Wage: ¬£{{ "{:,.0f}".format(analysis_result.squad_avg_wage) }} p/w
                                {% if analysis_result.game_date %}
                                | Season: {{ analysis_result.get_season_display() }}
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <a href="{{ url_for('projects.export_squad_audit') }}" class="btn btn-success me-2">
                                <i class="bi bi-download"></i> Export CSV
                            </a>
                            <a href="{{ url_for('projects.new_squad_audit') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> New Analysis
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="card-body bg-light border-bottom">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="p-2">
                                <h3 class="text-success mb-0">{{ analysis_result.get_elite_players()|length }}</h3>
                                <small class="text-muted">Elite Performers</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-2">
                                <h3 class="text-danger mb-0">{{ analysis_result.get_poor_performers()|length }}</h3>
                                <small class="text-muted">Poor Performers</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-2">
                                <h3 class="text-warning mb-0">{{ analysis_result.get_transfer_listed_elite()|length }}
                                </h3>
                                <small class="text-muted">Elite on Transfer List</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-2">
                                <h3 class="text-primary mb-0">{{ analysis_result.total_players }}</h3>
                                <small class="text-muted">Total Players</small>
                            </div>
                        </div>
                    </div>
                    {% if analysis_result.selected_division %}
                    <div class="row mt-3">
                        <div class="col-12 text-center">
                            <div class="p-2">
                                <h5 class="text-info mb-0">
                                    {{ analysis_result.selected_division }}
                                    {% if league_baselines and league_baselines.is_low_sample_size(analysis_result.selected_division) %}
                                        <span class="badge bg-warning small">‚ö†Ô∏è Low Sample</span>
                                    {% endif %}
                                </h5>
                                <small class="text-muted">
                                    League Comparison
                                    {% if league_baselines %}
                                        ({{ league_baselines.get_division_player_count(analysis_result.selected_division) }} players in dataset)
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% if league_baselines and league_baselines.is_low_sample_size(analysis_result.selected_division) %}
                    <div class="row mt-2">
                        <div class="col-12">
                            <div class="alert alert-warning mb-0">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>Low Sample Size:</strong> This division has fewer than 100 players in the baseline dataset. League averages may not be fully representative.
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                </div>

                <!-- Filters and Search -->
                <div class="card-body border-bottom">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <input type="text" id="searchInput" class="form-control" placeholder="Search by name...">
                        </div>
                        <div class="col-md-3">
                            <select id="positionFilter" class="form-select">
                                <option value="">All Positions</option>
                                <option value="GK">GK - Goalkeeper</option>
                                <option value="CB">CB - Center Back</option>
                                <option value="FB">FB - Fullback</option>
                                <option value="DM">DM - Defensive Mid</option>
                                <option value="CM">CM - Central Mid</option>
                                <option value="AM">AM - Attacking Mid</option>
                                <option value="W">W - Winger</option>
                                <option value="ST">ST - Striker</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select id="verdictFilter" class="form-select">
                                <option value="">All Performance Levels</option>
                                <option value="ELITE">Elite Only</option>
                                <option value="GOOD">Good Only</option>
                                <option value="AVERAGE">Average Only</option>
                                <option value="POOR">Poor Only</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button id="clearFilters" class="btn btn-outline-secondary w-100">Clear Filters</button>
                        </div>
                    </div>
                </div>

                <!-- Results Table - Simplified with Expandable Details -->
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="squadTable">
                            <thead class="table-light">
                                <tr>
                                    <th class="sortable" data-sort="name" style="cursor: pointer;">
                                        Name <i class="bi bi-arrow-down-up"></i>
                                    </th>
                                    <th class="sortable" data-sort="position" style="cursor: pointer;">
                                        Pos <i class="bi bi-arrow-down-up"></i>
                                    </th>
                                    <th class="sortable text-center" data-sort="age" style="cursor: pointer;">
                                        Age <i class="bi bi-arrow-down-up"></i>
                                    </th>
                                    <th class="sortable text-end" data-sort="value" style="cursor: pointer;">
                                        Value
                                        <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip"
                                            title="Value Score = (Role Score / Wage Index) √ó 100"></i>
                                        <i class="bi bi-arrow-down-up"></i>
                                    </th>
                                    <th class="sortable text-center" data-sort="verdict" style="cursor: pointer;">
                                        Verdict <i class="bi bi-arrow-down-up"></i>
                                    </th>
                                    <th class="text-end">Wage</th>
                                    <th>Action</th>
                                    <th style="width: 40px;"></th>
                                </tr>
                            </thead>
                            {% for analysis in analysis_result.get_sorted_by_value() %}
                            <tbody class="player-group" data-player-id="{{ loop.index }}"
                                   data-name="{{ analysis.player.name|lower }}"
                                   data-position="{{ analysis.player.get_position_category().value }}"
                                   data-all-positions="{% for pos in analysis.player.all_possible_positions %}{{ pos.value }}{% if not loop.last %},{% endif %}{% endfor %}"
                                   data-verdict="{{ analysis.player.best_role.tier }}"
                                   data-value="{{ analysis.value_score }}"
                                   data-insufficient-data="{% if analysis.player.mins is not none and analysis.player.mins < 200 %}true{% else %}false{% endif %}">
                                <!-- Main Row (7 columns + expand) -->
                                <tr class="player-row">
                                    <td class="fw-semibold">{{ analysis.player.name }}</td>
                                    <td>
                                        <span class="badge bg-secondary">{{ analysis.player.position }}</span>
                                    </td>
                                    <td class="text-center">{{ analysis.player.age }}</td>
                                    <td class="text-end">
                                        {% if analysis.player.mins is not none and analysis.player.mins < 200 %}
                                        <span class="badge bg-secondary fs-6">N/A</span>
                                        {% else %}
                                        <span class="badge bg-{{ analysis.get_value_score_color() }} fs-6">
                                            {{ "%.1f"|format(analysis.value_score) }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if analysis.player.mins is not none and analysis.player.mins < 200 %}
                                        <span class="badge bg-secondary">N/A</span>
                                        {% else %}
                                        <span class="badge bg-{{ analysis.get_verdict_color() }}">
                                            {{ analysis.player.best_role.tier }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end small" style="white-space: nowrap;">{{ analysis.player.get_wage_formatted() }}</td>
                                    <td>
                                        <span class="badge bg-{{ analysis.recommendation.color }}"
                                              title="{{ analysis.recommendation.get_title() }}"
                                              aria-label="{{ analysis.recommendation.get_title() }}">
                                            {{ analysis.recommendation.icon }} {{ analysis.recommendation.badge }}
                                            {% if analysis.recommendation.has_contract_warning %}
                                            <span class="ms-1">‚è∞</span>
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-link text-muted p-0 expand-btn" type="button"
                                                aria-label="Expand details">
                                            <i class="bi bi-chevron-right expand-icon"></i>
                                        </button>
                                    </td>
                                </tr>
                                <!-- Detail Row (hidden by default) -->
                                <tr class="detail-row d-none {% if analysis.player.mins is not none and analysis.player.mins < 200 %}hard-floor{% elif analysis.player.mins is not none and analysis.player.mins < 500 %}soft-floor{% endif %}">
                                    <td colspan="8" class="bg-light p-0">
                                        <div class="detail-panel p-3">
                                            <!-- Minutes Warning Banner -->
                                            {% if analysis.player.mins is not none and analysis.player.mins < 200 %}
                                            <div class="alert alert-warning py-2 mb-3">
                                                <i class="bi bi-exclamation-triangle"></i>
                                                <strong>Insufficient Data</strong> - Only {{ analysis.player.mins }} minutes played. Stats unreliable.
                                            </div>
                                            {% elif analysis.player.mins is not none and analysis.player.mins < 500 %}
                                            <div class="alert alert-warning py-2 mb-3">
                                                <i class="bi bi-exclamation-triangle"></i>
                                                <strong>Projected Stats</strong> - Only {{ analysis.player.mins }} minutes played. Treat as provisional.
                                            </div>
                                            {% endif %}

                                            <div class="row">
                                                <!-- Left: Role & KPIs -->
                                                <div class="col-md-7">
                                                    <!-- Best Role -->
                                                    <div class="mb-3">
                                                        <strong>Best Role:</strong>
                                                        {% if analysis.player.best_role %}
                                                        <span class="badge bg-primary ms-1"
                                                              data-player-name="{{ analysis.player.name }}"
                                                              onclick="openRoleModal(this.dataset.playerName)"
                                                              style="cursor: pointer;">
                                                            {{ analysis.player.best_role.display_name }}
                                                        </span>
                                                        <small class="text-muted">(click for full breakdown)</small>
                                                        {% else %}
                                                        <span class="text-muted">N/A</span>
                                                        {% endif %}
                                                    </div>

                                                    <!-- KPI Bars -->
                                                    {% if analysis.player.best_role and analysis.player.best_role.metric_scores %}
                                                    {% set metrics = analysis.player.best_role.metric_scores %}
                                                    {% set primary_metrics = [] %}
                                                    {% set secondary_metrics = [] %}
                                                    {% for metric_name, metric_data in metrics.items() %}
                                                        {% if metric_data.weight == 'PRIMARY' %}
                                                            {% set _ = primary_metrics.append((metric_name, metric_data)) %}
                                                        {% else %}
                                                            {% set _ = secondary_metrics.append((metric_name, metric_data)) %}
                                                        {% endif %}
                                                    {% endfor %}

                                                    <!-- Primary KPIs -->
                                                    {% if primary_metrics %}
                                                    <div class="mb-3">
                                                        <small class="text-uppercase text-muted fw-bold">Primary KPIs (70% weight)</small>
                                                        <div class="kpi-bars mt-2">
                                                            {% for metric_name, metric_data in primary_metrics %}
                                                            {% set bar_width = [metric_data.score, 100]|min %}
                                                            {% set tier_color = {'ELITE': 'success', 'GOOD': 'info', 'AVERAGE': 'warning', 'POOR': 'danger', 'CRITICAL': 'dark'}.get(metric_data.tier, 'secondary') %}
                                                            <div class="kpi-bar-row d-flex align-items-center mb-2">
                                                                <div class="kpi-label small" style="width: 100px;">{{ metric_name.replace('_90', '/90').replace('_pct', '%').replace('_', ' ').title() }}</div>
                                                                <div class="kpi-bar-container flex-grow-1 mx-2" style="height: 12px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                                                                    <div class="kpi-bar-fill bg-{{ tier_color }}" data-width="{{ bar_width }}" style="height: 100%; width: 0; border-radius: 4px;"></div>
                                                                </div>
                                                                <span class="badge bg-{{ tier_color }} kpi-tier" style="width: 60px;">{{ metric_data.tier }}</span>
                                                                <small class="text-muted ms-2" style="width: 50px;">{{ "%.2f"|format(metric_data.value) }}</small>
                                                            </div>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                    {% endif %}

                                                    <!-- Secondary KPIs -->
                                                    {% if secondary_metrics %}
                                                    <div class="mb-3">
                                                        <small class="text-uppercase text-muted fw-bold">Secondary KPIs (30% weight)</small>
                                                        <div class="kpi-bars mt-2">
                                                            {% for metric_name, metric_data in secondary_metrics %}
                                                            {% set bar_width = [metric_data.score, 100]|min %}
                                                            {% set tier_color = {'ELITE': 'success', 'GOOD': 'info', 'AVERAGE': 'warning', 'POOR': 'danger', 'CRITICAL': 'dark'}.get(metric_data.tier, 'secondary') %}
                                                            <div class="kpi-bar-row d-flex align-items-center mb-2">
                                                                <div class="kpi-label small" style="width: 100px;">{{ metric_name.replace('_90', '/90').replace('_pct', '%').replace('_', ' ').title() }}</div>
                                                                <div class="kpi-bar-container flex-grow-1 mx-2" style="height: 12px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                                                                    <div class="kpi-bar-fill bg-{{ tier_color }}" data-width="{{ bar_width }}" style="height: 100%; width: 0; border-radius: 4px;"></div>
                                                                </div>
                                                                <span class="badge bg-{{ tier_color }} kpi-tier" style="width: 60px;">{{ metric_data.tier }}</span>
                                                                <small class="text-muted ms-2" style="width: 50px;">{{ "%.2f"|format(metric_data.value) }}</small>
                                                            </div>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                    {% else %}
                                                    <p class="text-muted small">No metric data available</p>
                                                    {% endif %}
                                                </div>

                                                <!-- Right: Contract, League Value, Action -->
                                                <div class="col-md-5">
                                                    <div class="bg-white rounded p-3 border">
                                                        <!-- Contract -->
                                                        <div class="mb-2">
                                                            <strong>Contract:</strong>
                                                            <span class="badge bg-{{ analysis.player.get_contract_expiry_color(analysis_result.game_date) }} ms-1">
                                                                {{ analysis.player.get_contract_expiry_relative(analysis_result.game_date) }}
                                                            </span>
                                                            {% if analysis.player.expires and analysis.player.expires != "-" %}
                                                            <small class="text-muted">({{ analysis.player.expires }})</small>
                                                            {% endif %}
                                                        </div>

                                                        <!-- League Value -->
                                                        {% if analysis.league_value_score is not none %}
                                                        <div class="mb-2">
                                                            <strong>League Value:</strong>
                                                            <span class="badge bg-{{ analysis.get_league_value_score_color() }} ms-1">
                                                                {{ "%.1f"|format(analysis.league_value_score) }}
                                                            </span>
                                                            <small class="text-muted">({{ "%.0f"|format(analysis.league_wage_percentile) }}th percentile)</small>
                                                            {% if analysis.league_baseline and analysis.league_baseline.player_count == 0 %}
                                                            <span class="badge bg-secondary small">Estimated</span>
                                                            {% endif %}
                                                            {% set comparison = analysis.get_value_comparison_indicator() %}
                                                            {% if comparison %}
                                                            <br>
                                                            <span class="badge bg-{{ 'primary' if comparison == 'League Bargain' else 'warning' }} small mt-1"
                                                                  title="{% if comparison == 'League Bargain' %}Underpaid vs league avg{% else %}Squad wages explain lower league value{% endif %}">
                                                                {{ comparison }}
                                                            </span>
                                                            {% endif %}
                                                        </div>
                                                        {% endif %}

                                                        <!-- Action Explanation -->
                                                        <div class="mt-3 pt-2 border-top">
                                                            <strong>Action:</strong>
                                                            <span class="badge bg-{{ analysis.recommendation.color }} ms-1">
                                                                {{ analysis.recommendation.icon }} {{ analysis.recommendation.badge }}
                                                            </span>
                                                            <p class="text-muted small mb-0 mt-1">{{ analysis.recommendation.explanation }}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                            {% endfor %}
                        </table>
                    </div>
                </div>

                <div class="card-footer bg-white text-muted small">
                    <div class="row">
                        <div class="col-md-6">
                            Showing <strong id="visibleCount">{{ analysis_result.total_players }}</strong> of {{
                            analysis_result.total_players }} players
                        </div>
                        <div class="col-md-6 text-md-end">
                            Sorted by <strong id="currentSort">Value Score (Descending)</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Elite Players Highlight -->
    {% if analysis_result.get_elite_players() %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm border-start border-success border-4">
                <div class="card-body">
                    <h5 class="card-title text-success">
                        <i class="bi bi-star-fill"></i> Elite Performers ({{ analysis_result.get_elite_players()|length
                        }})
                    </h5>
                    <p class="text-muted small mb-3">Players performing significantly above their position averages</p>
                    <div class="row">
                        {% for analysis in analysis_result.get_elite_players()[:5] %}
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0">
                                    <span class="badge bg-success rounded-pill">{{
                                        analysis.player.get_position_category().value }}</span>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1">{{ analysis.player.name }} ({{ analysis.player.age }})</h6>
                                    <p class="mb-1 small">
                                        <strong>Value:</strong> {{ "%.1f"|format(analysis.value_score) }} |
                                        <strong>Performance:</strong> {{ "%.1f"|format(analysis.performance_index) }}
                                    </p>
                                    <p class="mb-0 small text-muted">{{ analysis.recommendation.badge }} - {{ analysis.recommendation.explanation }}</p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Transfer Listed Elite Warning -->
    {% if analysis_result.get_transfer_listed_elite() %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning border-start border-warning border-4">
                <h5 class="alert-heading">
                    <i class="bi bi-exclamation-triangle-fill"></i> Elite Players on Transfer List
                </h5>
                <p class="mb-2">The following elite performers are listed for transfer - consider investigating:</p>
                <ul class="mb-0">
                    {% for analysis in analysis_result.get_transfer_listed_elite() %}
                    <li>
                        <strong>{{ analysis.player.name }}</strong> ({{ analysis.player.get_position_category().value
                        }}, Age {{ analysis.player.age }}) -
                        Value Score: {{ "%.1f"|format(analysis.value_score) }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Poor Performers Section with Wage Savings -->
    {% set poor_performers = analysis_result.get_poor_performers() %}
    {% if poor_performers %}
    {% set total_poor_wages = poor_performers | sum(attribute='player.wage') %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm border-start border-danger border-4">
                <div class="card-body">
                    <h5 class="card-title text-danger">
                        <i class="bi bi-exclamation-circle-fill"></i> Poor Performers - Priority Sales
                    </h5>
                    <p class="text-muted small mb-3">
                        Players with POOR on-pitch performance ratings.
                        These {{ poor_performers|length }} player(s) are underperforming and should be priority sales.
                        Potential savings: <strong class="text-danger">¬£{{ "{:,.0f}".format(total_poor_wages) }} p/w</strong>
                        (¬£{{ "{:,.0f}".format(total_poor_wages * 52) }}/year).
                    </p>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Player</th>
                                    <th class="text-center">Position</th>
                                    <th class="text-center">Age</th>
                                    <th class="text-end">Value Score</th>
                                    <th class="text-end">Performance</th>
                                    <th class="text-end">Wage</th>
                                    <th>Recommendation</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for analysis in poor_performers %}
                                <tr>
                                    <td class="fw-semibold">{{ analysis.player.name }}</td>
                                    <td class="text-center"><span class="badge bg-secondary">{{
                                            analysis.player.get_position_category().value }}</span></td>
                                    <td class="text-center">{{ analysis.player.age }}</td>
                                    <td class="text-end">
                                        {% if analysis.player.mins is not none and analysis.player.mins < 200 %}
                                        <span class="badge bg-secondary">N/A</span>
                                        {% else %}
                                        <span class="badge bg-{{ analysis.get_value_score_color() }}">
                                            {{ "%.1f"|format(analysis.value_score) }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if analysis.player.mins is not none and analysis.player.mins < 200 %}
                                        <span class="badge bg-secondary">N/A</span>
                                        {% else %}
                                        <span class="badge bg-danger">{{ "%.1f"|format(analysis.performance_index) }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end small" style="white-space: nowrap;">{{ analysis.player.get_wage_formatted() }}</td>
                                    <td class="small">
                                        <span class="badge bg-{{ analysis.recommendation.color }}">
                                            {{ analysis.recommendation.icon }} {{ analysis.recommendation.badge }}
                                        </span>
                                        <span class="text-muted ms-1">{{ analysis.recommendation.explanation }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="5" class="text-end fw-bold">Total Potential Savings:</td>
                                    <td class="text-end fw-bold text-danger">¬£{{ "{:,.0f}".format(total_poor_wages) }}
                                        p/w</td>
                                    <td class="text-muted small">(¬£{{ "{:,.0f}".format(total_poor_wages * 52) }}/year)
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Low Value Players Section (Not Poor, but Overpaid) -->
    {% set low_value_players = analysis_result.get_low_value_players() %}
    {% if low_value_players %}
    {% set total_low_value_wages = low_value_players | sum(attribute='player.wage') %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm border-start border-warning border-4">
                <div class="card-body">
                    <h5 class="card-title text-warning">
                        <i class="bi bi-exclamation-triangle-fill"></i> Overpaid Players - Consider Sale or Wage Reduction
                    </h5>
                    <p class="text-muted small mb-3">
                        Players with value scores below 50 despite adequate performance.
                        These {{ low_value_players|length }} player(s) may be overpaid relative to output.
                        Potential savings: <strong class="text-warning">¬£{{ "{:,.0f}".format(total_low_value_wages) }} p/w</strong>
                        (¬£{{ "{:,.0f}".format(total_low_value_wages * 52) }}/year).
                    </p>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Player</th>
                                    <th class="text-center">Position</th>
                                    <th class="text-center">Age</th>
                                    <th class="text-end">Value Score</th>
                                    <th class="text-end">Performance</th>
                                    <th class="text-end">Wage</th>
                                    <th>Recommendation</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for analysis in low_value_players %}
                                <tr>
                                    <td class="fw-semibold">{{ analysis.player.name }}</td>
                                    <td class="text-center"><span class="badge bg-secondary">{{
                                            analysis.player.get_position_category().value }}</span></td>
                                    <td class="text-center">{{ analysis.player.age }}</td>
                                    <td class="text-end">
                                        {% if analysis.player.mins is not none and analysis.player.mins < 200 %}
                                        <span class="badge bg-secondary">N/A</span>
                                        {% else %}
                                        <span class="badge bg-{{ analysis.get_value_score_color() }}">
                                            {{ "%.1f"|format(analysis.value_score) }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if analysis.player.mins is not none and analysis.player.mins < 200 %}
                                        <span class="badge bg-secondary">N/A</span>
                                        {% else %}
                                        <span class="badge bg-{{ analysis.get_verdict_color() }}">
                                            {{ analysis.verdict.value }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end small" style="white-space: nowrap;">{{ analysis.player.get_wage_formatted() }}</td>
                                    <td class="small">
                                        <span class="badge bg-{{ analysis.recommendation.color }}">
                                            {{ analysis.recommendation.icon }} {{ analysis.recommendation.badge }}
                                        </span>
                                        <span class="text-muted ms-1">{{ analysis.recommendation.explanation }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="5" class="text-end fw-bold">Potential Wage Savings:</td>
                                    <td class="text-end fw-bold text-warning">¬£{{ "{:,.0f}".format(total_low_value_wages) }}
                                        p/w</td>
                                    <td class="text-muted small">(¬£{{ "{:,.0f}".format(total_low_value_wages * 52) }}/year)
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Formation Suggestions -->
    {% if analysis_result %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm border-start border-primary border-4">
                <div class="card-body">
                    <h5 class="card-title text-primary">
                        <i class="bi bi-diagram-3-fill"></i> Recommended Formations
                    </h5>

                    {% if formation_suggestions and formation_suggestions|length > 0 %}
                    <p class="text-muted small mb-4">
                        Formations optimized to maximize your elite and good performers. Ranked by quality of available
                        players.
                    </p>

                    {% for formation in formation_suggestions %}
                    <div class="mb-4 {% if not loop.last %}pb-3 border-bottom{% endif %}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">
                                {% if loop.first %}
                                <span class="badge bg-success me-2">1st Choice</span>
                                {% elif loop.index == 2 %}
                                <span class="badge bg-info me-2">2nd Choice</span>
                                {% else %}
                                <span class="badge bg-secondary me-2">3rd Choice</span>
                                {% endif %}
                                <strong>{{ formation.name }}</strong>
                                {% if formation.total_recruitment_needed > 0 %}
                                <span class="badge bg-danger ms-2">{{ formation.total_recruitment_needed }} recruit{{ 's' if formation.total_recruitment_needed != 1 else '' }} needed</span>
                                {% else %}
                                <span class="badge bg-success ms-2">Squad complete</span>
                                {% endif %}
                            </h6>
                            <span class="badge bg-dark">Quality Score: {{ formation.score }}</span>
                        </div>

                        <div class="row g-2 mt-2">
                            {% for pos_data in formation.breakdown %}
                            <div class="col-6 col-md-4 col-lg-3">
                                <div
                                    class="card border {% if pos_data.elite >= pos_data.required %}border-success{% elif pos_data.elite + pos_data.good >= pos_data.required %}border-info{% elif pos_data.recruitment_needed > 0 %}border-danger{% else %}border-warning{% endif %} bg-light">
                                    <div class="card-body p-2 small">
                                        <div class="fw-bold">{{ pos_data.position }} ({{ pos_data.required }} needed)
                                        </div>
                                        <div class="text-muted">
                                            <i class="bi bi-star-fill text-success"></i> {{ pos_data.elite }} Elite
                                            <br>
                                            <i class="bi bi-star-half text-info"></i> {{ pos_data.good }} Good
                                            {% if pos_data.recruitment_needed > 0 %}
                                            <br>
                                            <i class="bi bi-plus-circle text-danger"></i> <span class="text-danger fw-bold">{{ pos_data.recruitment_needed }} to recruit</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Best XI Toggle Button -->
                        <div class="mt-3">
                            <button class="btn btn-outline-primary btn-sm"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#bestXI-{{ loop.index }}"
                                    aria-expanded="false">
                                <i class="bi bi-people-fill"></i> Show Best XI
                            </button>
                        </div>

                        <!-- Best XI Collapse Section -->
                        <div class="collapse mt-3" id="bestXI-{{ loop.index }}">
                            {% if formation.best_xi %}
                            <!-- Starting XI - Pitch Visualization -->
                            <div class="card border-success">
                                <div class="card-header py-2 bg-success bg-opacity-10">
                                    <strong><i class="bi bi-trophy-fill text-success"></i> Starting XI</strong>
                                    <span class="badge bg-dark float-end">
                                        Quality: {{ formation.best_xi.total_quality_score|round|int }}
                                    </span>
                                </div>
                                <div class="card-body p-2">
                                    <!-- Pitch Container -->
                                    <div class="pitch-container position-relative mx-auto" style="max-width: 500px; aspect-ratio: 3/4; background: linear-gradient(to bottom, #2d5a27 0%, #3d7a37 50%, #2d5a27 100%); border-radius: 8px; border: 3px solid #fff;">
                                        <!-- Pitch markings -->
                                        <div class="pitch-markings position-absolute w-100 h-100" style="pointer-events: none;">
                                            <!-- Center circle -->
                                            <div class="position-absolute" style="width: 80px; height: 80px; border: 2px solid rgba(255,255,255,0.5); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>
                                            <!-- Halfway line -->
                                            <div class="position-absolute" style="width: 100%; height: 2px; background: rgba(255,255,255,0.5); top: 50%;"></div>
                                            <!-- Penalty area (top) -->
                                            <div class="position-absolute" style="width: 60%; height: 15%; border: 2px solid rgba(255,255,255,0.5); border-top: none; top: 0; left: 20%;"></div>
                                            <!-- Penalty area (bottom) -->
                                            <div class="position-absolute" style="width: 60%; height: 15%; border: 2px solid rgba(255,255,255,0.5); border-bottom: none; bottom: 0; left: 20%;"></div>
                                        </div>

                                        <!-- Players positioned by formation -->
                                        {% for pos in formation.best_xi.get_pitch_positions() %}
                                        <div class="position-absolute text-center xi-player-slot"
                                             draggable="true"
                                             data-formation-idx="{{ loop.index0 }}"
                                             data-player-name="{{ pos.player_analysis.player.name }}"
                                             data-position="{{ pos.assigned_position.value }}"
                                             data-role="{{ pos.assigned_role }}"
                                             data-score="{{ pos.position_score }}"
                                             data-verdict="{{ pos.player_analysis.verdict.name }}"
                                             data-natural-positions="{{ pos.player_analysis.player.position }}"
                                             data-slot-type="xi"
                                             data-slot-x="{{ pos.x }}"
                                             data-slot-y="{{ pos.y }}"
                                             style="left: {{ pos.x }}%; top: {{ pos.y }}%; transform: translate(-50%, -50%); width: 80px; cursor: grab;">
                                            <div class="badge {% if pos.assigned_position.value == 'GK' %}bg-warning text-dark{% else %}bg-info{% endif %} rounded-circle mx-auto mb-1 player-badge" style="width: 36px; height: 36px; line-height: 32px; font-size: 0.7rem;">
                                                {{ pos.assigned_position.value }}
                                            </div>
                                            <div class="bg-white bg-opacity-90 rounded px-1 py-0 player-label" style="font-size: 0.65rem;">
                                                <div class="fw-bold text-truncate player-name">{{ pos.player_analysis.player.name.split(' ')[-1] }}</div>
                                                <div class="text-muted player-role" style="font-size: 0.55rem;">{{ pos.role_display }}</div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <!-- Bench - Compact List with Gap Warnings -->
                            <div class="card bg-light mt-2">
                                <div class="card-header py-2">
                                    <strong><i class="bi bi-people"></i> Bench ({{ formation.best_xi.bench|length }})</strong>
                                    {% if formation.best_xi.bench_gaps %}
                                    <span class="badge bg-warning text-dark float-end">
                                        <i class="bi bi-exclamation-triangle"></i> {{ formation.best_xi.bench_gaps|length }} gap(s)
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="card-body p-2">
                                    <div class="d-flex flex-wrap gap-2 bench-container">
                                        {# Show filled bench slots #}
                                        {% for assignment in formation.best_xi.bench %}
                                        <div class="d-flex align-items-center bg-white rounded border px-2 py-1 bench-player-slot"
                                             draggable="true"
                                             data-bench-idx="{{ loop.index0 }}"
                                             data-player-name="{{ assignment.player_analysis.player.name }}"
                                             data-position="{{ assignment.assigned_position.value }}"
                                             data-role="{{ assignment.assigned_role }}"
                                             data-score="{{ assignment.position_score }}"
                                             data-verdict="{{ assignment.player_analysis.verdict.name }}"
                                             data-natural-positions="{{ assignment.player_analysis.player.position }}"
                                             data-slot-type="bench"
                                             title="{{ assignment.get_role_display_name() }}"
                                             style="cursor: grab;">
                                            <span class="badge {% if 'GK' in assignment.player_analysis.player.position %}bg-warning text-dark{% else %}bg-info{% endif %} me-1 player-badge" style="font-size: 0.65rem;">
                                                {{ assignment.player_analysis.player.position }}
                                            </span>
                                            <span class="small text-truncate player-name" style="max-width: 100px;">
                                                {{ assignment.player_analysis.player.name.split(' ')[-1] }}
                                            </span>
                                        </div>
                                        {% endfor %}

                                        {# Show empty slots for unfilled mandatory positions (recruitment warnings) #}
                                        {% for gap in formation.best_xi.bench_gaps %}
                                        {% for i in range(gap.count_missing) %}
                                        <div class="d-flex align-items-center rounded px-2 py-1" style="border: 2px dashed #dc3545; background: rgba(220, 53, 69, 0.1);">
                                            <span class="badge bg-danger me-1" style="font-size: 0.65rem;">
                                                {{ gap.group }}
                                            </span>
                                            <span class="small text-danger">
                                                {{ gap.display_name }}
                                            </span>
                                        </div>
                                        {% endfor %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="alert alert-warning mb-0">
                                <i class="bi bi-exclamation-triangle"></i> Unable to generate Best XI
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}

                    <div class="alert alert-info mt-3 mb-0">
                        <i class="bi bi-info-circle-fill"></i>
                        <strong>Tip:</strong> These formations prioritize positions where you have elite/good
                        performers.
                        Consider squad depth and tactical flexibility when making your final choice.
                    </div>
                    {% else %}
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>No formation suggestions available.</strong> Your squad may not have enough players in
                        the required positions to fill standard formations. This typically occurs with smaller squads or
                        squads with unusual position distributions.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% endif %}

    <!-- Back to Projects -->
    <div class="text-center mt-5">
        <a href="{{ url_for('projects.projects_home') }}" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left"></i> Back to Projects
        </a>
    </div>

    <!-- Role Detail Modal -->
    <div class="modal fade" id="roleDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" id="roleModalContent">
                <!-- Content loaded via AJAX -->
                <div class="modal-body text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if analysis_result %}
<!-- CSS for KPI Bar Animations and Detail Panels -->
<style>
    /* KPI Bar Animations */
    .kpi-bar-fill {
        width: 0;
        transition: width 0.4s ease-out 0.2s; /* 0.2s delay */
    }

    /* Desaturated bars for unreliable data */
    .detail-row.hard-floor .kpi-bar-fill {
        filter: grayscale(0.7) opacity(0.5);
    }
    .detail-row.hard-floor .kpi-bar-container {
        opacity: 0.6;
    }

    /* Expand button icon rotation */
    .expand-icon {
        transition: transform 0.2s ease;
    }
    .player-group.expanded .expand-icon {
        transform: rotate(90deg);
    }

    /* Detail panel styling */
    .detail-panel {
        border-top: 2px solid #dee2e6;
    }

    /* Hover effect on player row */
    .player-row:hover {
        background-color: rgba(0,0,0,0.02);
    }

    /* Best XI Drag-and-Drop Styles */
    .xi-player-slot.dragging,
    .bench-player-slot.dragging {
        opacity: 0.5;
        cursor: grabbing !important;
    }

    .xi-player-slot.drag-over,
    .bench-player-slot.drag-over {
        transform: translate(-50%, -50%) scale(1.1);
        box-shadow: 0 0 15px rgba(13, 110, 253, 0.7);
        z-index: 100;
    }

    .bench-player-slot.drag-over {
        transform: scale(1.05);
        box-shadow: 0 0 10px rgba(13, 110, 253, 0.7);
    }

    .xi-player-slot:hover,
    .bench-player-slot:hover {
        z-index: 50;
    }

    .pitch-container {
        user-select: none;
    }

    /* Quality score update animation */
    .quality-score-updated {
        animation: scoreFlash 0.6s ease-out;
    }

    @keyframes scoreFlash {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); background-color: #ffc107; }
        100% { transform: scale(1); }
    }

    /* Swap indicator */
    .swap-indicator {
        position: fixed;
        padding: 4px 8px;
        background: rgba(13, 110, 253, 0.9);
        color: white;
        border-radius: 4px;
        font-size: 0.75rem;
        pointer-events: none;
        z-index: 1000;
        display: none;
    }

    /* Methodology explainer chevron rotation */
    #methodologyExplainer.collapse:not(.show) ~ .card-header .bi-chevron-down,
    .card-header .collapsed .bi-chevron-down {
        transform: rotate(0deg);
        transition: transform 0.2s ease;
    }
    .card-header button:not(.collapsed) .bi-chevron-down {
        transform: rotate(180deg);
        transition: transform 0.2s ease;
    }
</style>

<!-- Methodology Explainer Section -->
{% if analysis_result %}
<div class="container mt-5 mb-4">
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-light py-2">
            <button class="btn btn-link text-decoration-none text-dark w-100 text-start d-flex justify-content-between align-items-center collapsed"
                    type="button" data-bs-toggle="collapse" data-bs-target="#methodologyExplainer">
                <span><i class="bi bi-info-circle me-2"></i><strong>How Are These Metrics Calculated?</strong></span>
                <i class="bi bi-chevron-down"></i>
            </button>
        </div>
        <div class="collapse" id="methodologyExplainer">
            <div class="card-body">
                <!-- Accordion for detailed sections -->
                <div class="accordion" id="methodologyAccordion">

                    <!-- 1. Overview -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#overviewSection">
                                <i class="bi bi-lightbulb me-2"></i>Overview: Role-Based Evaluation
                            </button>
                        </h2>
                        <div id="overviewSection" class="accordion-collapse collapse" data-bs-parent="#methodologyAccordion">
                            <div class="accordion-body">
                                <p>This system evaluates players based on <strong>12 distinct tactical roles</strong> rather than generic position categories. Each player is matched against all roles they could plausibly fill, and their <strong>best-fitting role</strong> determines their overall assessment.</p>

                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-muted">Tier 1: Specialized Roles</h6>
                                        <ul class="small mb-2">
                                            <li><strong>GK</strong> - Goalkeeper (shot-stopping, distribution)</li>
                                            <li><strong>CB-Stopper</strong> - Traditional defender (tackling, aerial)</li>
                                            <li><strong>BCB</strong> - Ball-playing CB (distribution, possession)</li>
                                            <li><strong>FB</strong> - Full-back (defensive balance)</li>
                                            <li><strong>WB</strong> - Wing-back (attacking width)</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-muted">Tier 2-3: Midfield & Attack</h6>
                                        <ul class="small mb-2">
                                            <li><strong>MD</strong> - Defensive midfielder (destroyer)</li>
                                            <li><strong>MC</strong> - Central midfielder (playmaker)</li>
                                            <li><strong>AM(C)</strong> - Attacking midfielder (creator)</li>
                                            <li><strong>WAP</strong> - Winger (provider, crossing)</li>
                                            <li><strong>WAS</strong> - Inside forward (goalscoring)</li>
                                            <li><strong>ST-Provider</strong> - Target forward (link play)</li>
                                            <li><strong>ST-GS</strong> - Advanced forward (finisher)</li>
                                        </ul>
                                    </div>
                                </div>

                                <div class="alert alert-info small mb-0 mt-2">
                                    <i class="bi bi-arrow-repeat me-1"></i>
                                    <strong>Interchangeability:</strong> Roles are grouped by tactical similarity. A player who scores well as a Wing-Back may also fit as a Full-Back or Wide Attacker, and the system tests all viable options.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Metric Thresholds -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#thresholdsSection">
                                <i class="bi bi-bar-chart me-2"></i>Performance Thresholds (Good / Average / Poor)
                            </button>
                        </h2>
                        <div id="thresholdsSection" class="accordion-collapse collapse" data-bs-parent="#methodologyAccordion">
                            <div class="accordion-body">
                                <p>Each role has specific <strong>Key Performance Indicators (KPIs)</strong> with three threshold levels that define performance bands. These thresholds are derived from <strong>league-wide statistical analysis</strong>.</p>

                                <div class="table-responsive">
                                    <table class="table table-sm small">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Band</th>
                                                <th>Score Range</th>
                                                <th>Interpretation</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr class="table-success">
                                                <td><span class="badge bg-success">ELITE</span></td>
                                                <td>100-120</td>
                                                <td>Above "Good" threshold - exceptional performance in this metric</td>
                                            </tr>
                                            <tr class="table-primary">
                                                <td><span class="badge bg-primary">GOOD</span></td>
                                                <td>70-100</td>
                                                <td>Between "OK" and "Good" thresholds - solid, reliable output</td>
                                            </tr>
                                            <tr class="table-warning">
                                                <td><span class="badge bg-warning text-dark">AVERAGE</span></td>
                                                <td>40-70</td>
                                                <td>Between "Poor" and "OK" thresholds - functional but not standout</td>
                                            </tr>
                                            <tr class="table-danger">
                                                <td><span class="badge bg-danger">POOR</span></td>
                                                <td>0-40</td>
                                                <td>Below "Poor" threshold - significant weakness in this area</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <h6 class="mt-3">Example: Center-Back (CB-Stopper) Thresholds</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered small">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Metric</th>
                                                <th class="text-success">Good</th>
                                                <th class="text-primary">OK</th>
                                                <th class="text-danger">Poor</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Header Win %</td>
                                                <td>82%</td>
                                                <td>72%</td>
                                                <td>59%</td>
                                            </tr>
                                            <tr>
                                                <td>Tackles per 90</td>
                                                <td>2.38</td>
                                                <td>1.29</td>
                                                <td>0.80</td>
                                            </tr>
                                            <tr>
                                                <td>Interceptions per 90</td>
                                                <td>3.18</td>
                                                <td>2.15</td>
                                                <td>1.36</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="alert alert-secondary small mb-0">
                                    <i class="bi bi-database me-1"></i>
                                    <strong>Data Source:</strong> Threshold values are calibrated against large sample data to represent realistic performance bands across divisions. Credit to <strong><a href="https://www.fmstag.com/" target="_blank" class="text-decoration-none">FMStag</a></strong> for the foundational Good/Average/Poor banding methodology.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Weighted Scoring -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#weightingSection">
                                <i class="bi bi-sliders me-2"></i>Primary vs Secondary KPIs (70/30 Weighting)
                            </button>
                        </h2>
                        <div id="weightingSection" class="accordion-collapse collapse" data-bs-parent="#methodologyAccordion">
                            <div class="accordion-body">
                                <p>Each role splits its KPIs into two categories with different weights:</p>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="card border-primary">
                                            <div class="card-body">
                                                <h6 class="card-title text-primary"><i class="bi bi-star-fill me-1"></i>Primary KPIs (70%)</h6>
                                                <p class="small mb-0">Role-defining metrics that distinguish this role from others. These are the core competencies - a CB-Stopper <em>must</em> win headers and make tackles.</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card border-secondary">
                                            <div class="card-body">
                                                <h6 class="card-title text-secondary"><i class="bi bi-star-half me-1"></i>Secondary KPIs (30%)</h6>
                                                <p class="small mb-0">Supporting attributes that enhance performance but aren't essential. A CB-Stopper with good passing is valuable, but it's not their primary job.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <h6>Scoring Formula</h6>
                                <div class="bg-light p-3 rounded font-monospace small mb-3">
                                    Overall Score = (Primary Avg √ó 0.7) + (Secondary Avg √ó 0.3)
                                </div>

                                <h6>Why This Matters</h6>
                                <p class="small mb-0">This weighting ensures a player can't compensate for poor core skills with excellent supporting attributes. A striker with amazing passing but poor finishing will still score lower than one with great finishing and average passing.</p>
                            </div>
                        </div>
                    </div>

                    <!-- 4. Performance Index & Value Score -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#valueSection">
                                <i class="bi bi-currency-pound me-2"></i>Performance Index & Value Score
                            </button>
                        </h2>
                        <div id="valueSection" class="accordion-collapse collapse" data-bs-parent="#methodologyAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6><i class="bi bi-graph-up text-primary me-1"></i>Performance Index (0-120)</h6>
                                        <p class="small">The weighted overall score from the player's best-fitting role. This represents pure on-pitch output regardless of wages.</p>
                                        <ul class="small">
                                            <li><strong>85+</strong> = ELITE tier</li>
                                            <li><strong>70-84</strong> = GOOD tier</li>
                                            <li><strong>50-69</strong> = AVERAGE tier</li>
                                            <li><strong>&lt;50</strong> = POOR tier</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="bi bi-piggy-bank text-success me-1"></i>Value Score</h6>
                                        <p class="small">Adjusts performance for wages relative to squad average. Identifies players who outperform (or underperform) their salary.</p>
                                        <div class="bg-light p-2 rounded font-monospace small mb-2">
                                            Value = Performance √∑ (Wage √∑ Squad Avg Wage)
                                        </div>
                                        <p class="small mb-0">A player earning 2√ó squad average needs 2√ó the performance to match a player on average wages.</p>
                                    </div>
                                </div>

                                <hr>

                                <h6><i class="bi bi-globe me-1"></i>League Value Score (Optional)</h6>
                                <p class="small mb-2">When you select a division, players are also compared against <strong>league-wide wage averages</strong> for their position. This reveals whether a player is a bargain or overpaid relative to the wider market.</p>

                                <div class="alert alert-success small mb-0">
                                    <i class="bi bi-tag me-1"></i>
                                    <strong>League Bargain:</strong> Players with a league value score 30+ points higher than their squad value may be undervalued relative to the market - they're performing above what their wages suggest for that division.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 5. Minutes Thresholds -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#minutesSection">
                                <i class="bi bi-clock me-2"></i>Minutes Played & Data Reliability
                            </button>
                        </h2>
                        <div id="minutesSection" class="accordion-collapse collapse" data-bs-parent="#methodologyAccordion">
                            <div class="accordion-body">
                                <p>Per-90 statistics can be misleading for players with limited minutes. The system applies different treatments based on sample size:</p>

                                <div class="table-responsive">
                                    <table class="table table-sm small">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Minutes</th>
                                                <th>Treatment</th>
                                                <th>Rationale</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr class="table-danger">
                                                <td><strong>&lt;200</strong></td>
                                                <td>Hard Floor - "LOW DATA" badge</td>
                                                <td>Too few minutes for reliable per-90 stats. One good/bad game skews everything.</td>
                                            </tr>
                                            <tr class="table-warning">
                                                <td><strong>200-500</strong></td>
                                                <td>Soft Floor - Bayesian Average applied</td>
                                                <td>Stats are blended with squad averages. At 200 mins, 100% squad average; at 500 mins, 100% player stats.</td>
                                            </tr>
                                            <tr class="table-success">
                                                <td><strong>500+</strong></td>
                                                <td>Full calculation</td>
                                                <td>Sufficient sample size for reliable per-90 statistics.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <h6>Bayesian Average Formula (200-500 mins)</h6>
                                <div class="bg-light p-2 rounded font-monospace small mb-2">
                                    Weight = (Minutes - 200) √∑ 300<br>
                                    Adjusted Stat = (Player Stat √ó Weight) + (Squad Avg √ó (1 - Weight))
                                </div>
                                <p class="small mb-0">This "regression to the mean" prevents a player with one brilliant 90-minute performance from appearing elite while protecting genuinely good players with limited opportunities.</p>
                            </div>
                        </div>
                    </div>

                    <!-- 6. Best XI Algorithm -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#bestXISection">
                                <i class="bi bi-people me-2"></i>Best XI Selection Algorithm
                            </button>
                        </h2>
                        <div id="bestXISection" class="accordion-collapse collapse" data-bs-parent="#methodologyAccordion">
                            <div class="accordion-body">
                                <p>The Best XI is generated using a <strong>greedy assignment algorithm</strong> that prioritizes positional scarcity:</p>

                                <ol class="small">
                                    <li><strong>Identify formation requirements</strong> (e.g., 4-3-3 needs 1 GK, 2 CB, 2 FB, 3 CM, 3 attackers)</li>
                                    <li><strong>Order positions by scarcity</strong> - positions with fewer available players are filled first</li>
                                    <li><strong>For each position</strong>, find the best available player using role evaluation scores</li>
                                    <li><strong>Mark player as used</strong> and continue to next position</li>
                                    <li><strong>Generate bench</strong> with minimum coverage (1 GK, 2 DEF, 1 MID, 2 AM, 1 ST) plus best remaining</li>
                                </ol>

                                <h6>Why Scarcity Order?</h6>
                                <p class="small mb-0">Filling scarce positions first prevents "wasting" versatile players. If you only have one natural striker, they should play ST rather than being used as a winger just because they happened to be evaluated first.</p>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Credits -->
                <div class="mt-4 pt-3 border-top">
                    <h6 class="text-muted"><i class="bi bi-heart me-1"></i>Credits & Acknowledgments</h6>
                    <p class="small text-muted mb-0">
                        Performance threshold methodology adapted from <strong><a href="https://www.fmstag.com/" target="_blank">FMStag</a></strong>'s analytical framework for Football Manager statistics.
                        The Good/Average/Poor banding system provides a statistically grounded approach to player evaluation that this tool builds upon with role-specific weighting and value calculations.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- JavaScript for Table Sorting, Filtering, and Expand/Collapse -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        const table = document.getElementById('squadTable');
        const playerGroups = Array.from(table.querySelectorAll('tbody.player-group'));
        const searchInput = document.getElementById('searchInput');
        const positionFilter = document.getElementById('positionFilter');
        const verdictFilter = document.getElementById('verdictFilter');
        const clearFiltersBtn = document.getElementById('clearFilters');
        const visibleCount = document.getElementById('visibleCount');
        const currentSortLabel = document.getElementById('currentSort');

        // Initialize current sort state (default: value score descending)
        let currentSort = { column: 'value', direction: 'desc' };

        // ==================== EXPAND/COLLAPSE ====================
        document.querySelectorAll('.expand-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const playerGroup = this.closest('.player-group');
                const detailRow = playerGroup.querySelector('.detail-row');
                const isExpanding = !playerGroup.classList.contains('expanded');

                // Toggle expanded state
                playerGroup.classList.toggle('expanded');
                detailRow.classList.toggle('d-none');
                detailRow.classList.toggle('expanded');

                // Animate KPI bars on expand
                if (isExpanding) {
                    setTimeout(() => {
                        detailRow.querySelectorAll('.kpi-bar-fill').forEach(bar => {
                            const targetWidth = bar.dataset.width || 0;
                            bar.style.width = targetWidth + '%';
                        });
                    }, 50); // Small delay for CSS transition to kick in
                } else {
                    // Reset bars on collapse
                    detailRow.querySelectorAll('.kpi-bar-fill').forEach(bar => {
                        bar.style.width = '0';
                    });
                }
            });
        });

        // Also allow clicking anywhere on the player row to expand (optional)
        document.querySelectorAll('.player-row').forEach(row => {
            row.style.cursor = 'pointer';
            row.addEventListener('click', function(e) {
                // Don't trigger if clicking on a badge or button
                if (e.target.closest('.badge') || e.target.closest('button')) return;

                const playerGroup = this.closest('.player-group');
                const expandBtn = playerGroup.querySelector('.expand-btn');
                expandBtn.click();
            });
        });

        window.openRoleModal = function (playerName) {
            const modal = new bootstrap.Modal(document.getElementById('roleDetailModal'));
            const content = document.getElementById('roleModalContent');
            const csrfToken = document.querySelector('input[name="csrf_token"]')?.value || '';

            content.innerHTML = `
                <div class="modal-body text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading role details...</p>
                </div>
            `;

            modal.show();

            fetch('/projects/squad-audit-tracker/player-roles', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ player_name: playerName })
            })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to load role details');
                    return response.text();
                })
                .then(html => {
                    content.innerHTML = html;
                })
                .catch(error => {
                    content.innerHTML = `
                    <div class="modal-header">
                        <h5 class="modal-title">Error</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> ${error.message}
                        </div>
                    </div>
                `;
                });
        };

        // ==================== SORTING ====================
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', function () {
                const column = this.dataset.sort;

                // Toggle direction if same column
                if (currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = column;
                    currentSort.direction = 'desc';
                }

                sortTable(column, currentSort.direction);
                updateSortLabel();
            });
        });

        function sortTable(column, direction) {
            // Performance verdict order mapping (ELITE > GOOD > AVERAGE > POOR)
            const verdictOrder = {
                'ELITE': 1,
                'GOOD': 2,
                'AVERAGE': 3,
                'POOR': 4
            };

            // Sort the playerGroups (tbody elements)
            const sortedGroups = [...playerGroups].sort((a, b) => {
                // Always put players with insufficient data at the bottom
                const aInsufficient = a.dataset.insufficientData === 'true';
                const bInsufficient = b.dataset.insufficientData === 'true';

                if (aInsufficient && !bInsufficient) return 1;
                if (!aInsufficient && bInsufficient) return -1;

                // Both have insufficient data or both have sufficient data - sort normally
                let aVal, bVal;
                const aRow = a.querySelector('.player-row');
                const bRow = b.querySelector('.player-row');

                if (column === 'name') {
                    aVal = a.dataset.name;
                    bVal = b.dataset.name;
                } else if (column === 'position') {
                    aVal = a.dataset.position;
                    bVal = b.dataset.position;
                } else if (column === 'verdict') {
                    // Use verdict order mapping instead of alphabetical
                    aVal = verdictOrder[a.dataset.verdict] || 99;
                    bVal = verdictOrder[b.dataset.verdict] || 99;
                } else if (column === 'age') {
                    // Age is in column index 2
                    aVal = parseInt(aRow.children[2].textContent);
                    bVal = parseInt(bRow.children[2].textContent);
                } else if (column === 'value') {
                    // Value is stored in data attribute on tbody
                    aVal = parseFloat(a.dataset.value) || 0;
                    bVal = parseFloat(b.dataset.value) || 0;
                }

                if (direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            // Re-append sorted tbody elements after thead
            const thead = table.querySelector('thead');
            sortedGroups.forEach(group => table.appendChild(group));
        }

        function updateSortLabel() {
            const labels = {
                name: 'Name',
                position: 'Position',
                age: 'Age',
                value: 'Value Score',
                verdict: 'Verdict'
            };
            const direction = currentSort.direction === 'asc' ? 'Ascending' : 'Descending';
            currentSortLabel.textContent = `${labels[currentSort.column]} (${direction})`;
        }

        // ==================== FILTERING ====================
        function filterRows() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedPosition = positionFilter.value;
            const selectedVerdict = verdictFilter.value;

            let visibleRowCount = 0;

            // Filter by showing/hiding entire tbody elements
            playerGroups.forEach(group => {
                const name = group.dataset.name;
                const position = group.dataset.position;
                const allPositions = group.dataset.allPositions ? group.dataset.allPositions.split(',') : [position];
                const verdict = group.dataset.verdict;

                const matchesSearch = !searchTerm || name.includes(searchTerm);
                const matchesPosition = !selectedPosition || allPositions.includes(selectedPosition);
                const matchesVerdict = !selectedVerdict || verdict === selectedVerdict;

                if (matchesSearch && matchesPosition && matchesVerdict) {
                    group.style.display = '';
                    visibleRowCount++;
                } else {
                    group.style.display = 'none';
                }
            });

            visibleCount.textContent = visibleRowCount;
        }

        searchInput.addEventListener('input', filterRows);
        positionFilter.addEventListener('change', filterRows);
        verdictFilter.addEventListener('change', filterRows);

        clearFiltersBtn.addEventListener('click', function () {
            searchInput.value = '';
            positionFilter.value = '';
            verdictFilter.value = '';
            filterRows();
        });

        // Initial sort label
        updateSortLabel();

        // NOTE: Position change handler removed - feature needs reimplementation for new expandable table structure

        // Reinitialize tooltips after any dynamic content changes
        function reinitializeTooltips() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                // Dispose existing tooltip if any
                var existingTooltip = bootstrap.Tooltip.getInstance(tooltipTriggerEl);
                if (existingTooltip) {
                    existingTooltip.dispose();
                }
                // Create new tooltip
                new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        // Call initially to ensure tooltips work
        reinitializeTooltips();

        // ==================== BEST XI DRAG AND DROP ====================
        initBestXIDragAndDrop();

        function initBestXIDragAndDrop() {
            // Find all Best XI sections
            document.querySelectorAll('[id^="bestXI-"]').forEach(section => {
                const pitchContainer = section.querySelector('.pitch-container');
                const benchContainer = section.querySelector('.bench-container');
                const qualityBadge = section.querySelector('.badge.bg-dark');

                if (!pitchContainer || !benchContainer) return;

                let draggedElement = null;
                let draggedData = null;

                // Get all draggable elements in this section
                const getAllDraggables = () => [
                    ...section.querySelectorAll('.xi-player-slot'),
                    ...section.querySelectorAll('.bench-player-slot')
                ];

                // Calculate total score for XI players
                const calculateTotalScore = () => {
                    let total = 0;
                    section.querySelectorAll('.xi-player-slot').forEach(slot => {
                        total += parseFloat(slot.dataset.score) || 0;
                    });
                    return Math.round(total);
                };

                // Update quality badge with animation
                const updateQualityBadge = () => {
                    if (!qualityBadge) return;
                    const newScore = calculateTotalScore();
                    qualityBadge.textContent = `Quality: ${newScore}`;
                    qualityBadge.classList.add('quality-score-updated');
                    setTimeout(() => qualityBadge.classList.remove('quality-score-updated'), 600);
                };

                // Swap player data between two slots
                const swapPlayers = (slot1, slot2) => {
                    // Store slot1 data
                    const slot1Data = {
                        playerName: slot1.dataset.playerName,
                        position: slot1.dataset.position,
                        role: slot1.dataset.role,
                        score: slot1.dataset.score,
                        verdict: slot1.dataset.verdict,
                        naturalPositions: slot1.dataset.naturalPositions,
                        displayName: slot1.querySelector('.player-name')?.textContent.trim(),
                        roleDisplay: slot1.querySelector('.player-role')?.textContent.trim()
                    };

                    // Store slot2 data
                    const slot2Data = {
                        playerName: slot2.dataset.playerName,
                        position: slot2.dataset.position,
                        role: slot2.dataset.role,
                        score: slot2.dataset.score,
                        verdict: slot2.dataset.verdict,
                        naturalPositions: slot2.dataset.naturalPositions,
                        displayName: slot2.querySelector('.player-name')?.textContent.trim(),
                        roleDisplay: slot2.querySelector('.player-role')?.textContent.trim()
                    };

                    // Apply slot2 data to slot1
                    applyPlayerData(slot1, slot2Data);
                    // Apply slot1 data to slot2
                    applyPlayerData(slot2, slot1Data);

                    updateQualityBadge();
                };

                // Check if player can naturally play a given slot position
                const canPlayPosition = (naturalPositions, slotPosition) => {
                    if (!naturalPositions) return true; // Assume yes if unknown
                    const np = naturalPositions.toUpperCase();
                    const sp = slotPosition.toUpperCase();

                    // Direct matches
                    if (sp === 'GK') return np.includes('GK');
                    if (sp === 'CB') return np.includes('D ') || np.includes('D(') || np === 'D';
                    if (sp === 'FB') return np.includes('D ') || np.includes('D(') || np.includes('WB') || np === 'D';
                    if (sp === 'DM') return np.includes('DM') || np.includes('M (');
                    if (sp === 'CM') return np.includes('M ') || np.includes('M(') || np.includes('DM') || np === 'M';
                    if (sp === 'AM') return np.includes('AM') || np.includes('M ') || np.includes('M(');
                    if (sp === 'W') return np.includes('AM') || np.includes('M ') || np.includes('M(') || np.includes('WB');
                    if (sp === 'ST') return np.includes('ST');

                    return true; // Default to allowing
                };

                // Apply player data to a slot
                const applyPlayerData = (slot, data) => {
                    slot.dataset.playerName = data.playerName;
                    slot.dataset.score = data.score;
                    slot.dataset.verdict = data.verdict;
                    slot.dataset.naturalPositions = data.naturalPositions;

                    // Update display name
                    const nameEl = slot.querySelector('.player-name');
                    if (nameEl) {
                        nameEl.textContent = data.displayName;
                    }

                    // For XI slots: role stays fixed to the pitch position (don't swap)
                    // For bench slots: update the title attribute
                    if (slot.classList.contains('bench-player-slot')) {
                        slot.title = data.roleDisplay || data.role;
                    }

                    // Update badge color based on position (GK = yellow, outfield = teal)
                    // Also check for out-of-position warning on XI slots
                    const badge = slot.querySelector('.player-badge');
                    if (badge) {
                        // Remove old background and text color classes
                        badge.className = badge.className.replace(/bg-\w+/g, '').replace(/text-\w+/g, '').trim();

                        const slotPosition = slot.dataset.position;
                        const isXiSlot = slot.classList.contains('xi-player-slot');
                        const isOutOfPosition = isXiSlot && !canPlayPosition(data.naturalPositions, slotPosition);

                        if (isOutOfPosition) {
                            // Out of position warning - red/danger styling
                            badge.classList.add('bg-danger', 'text-white');
                        } else if (slotPosition === 'GK') {
                            badge.classList.add('bg-warning', 'text-dark');
                        } else {
                            badge.classList.add('bg-info');
                        }
                    }

                    // Add/remove out-of-position indicator on the player label
                    const labelEl = slot.querySelector('.player-label');
                    if (labelEl && slot.classList.contains('xi-player-slot')) {
                        const slotPosition = slot.dataset.position;
                        const isOutOfPosition = !canPlayPosition(data.naturalPositions, slotPosition);
                        if (isOutOfPosition) {
                            labelEl.style.border = '2px solid #dc3545';
                        } else {
                            labelEl.style.border = '';
                        }
                    }
                };

                // Get Bootstrap color class from verdict
                const getVerdictColor = (verdict) => {
                    const colors = {
                        'ELITE': 'bg-success',
                        'GOOD': 'bg-primary',
                        'AVERAGE': 'bg-warning',
                        'POOR': 'bg-danger'
                    };
                    return colors[verdict] || 'bg-secondary';
                };

                // Drag start handler
                const handleDragStart = (e) => {
                    draggedElement = e.target.closest('.xi-player-slot, .bench-player-slot');
                    if (!draggedElement) return;

                    draggedData = {
                        slotType: draggedElement.dataset.slotType,
                        playerName: draggedElement.dataset.playerName
                    };

                    draggedElement.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', draggedElement.dataset.playerName);
                };

                // Drag end handler
                const handleDragEnd = (e) => {
                    if (draggedElement) {
                        draggedElement.classList.remove('dragging');
                    }
                    getAllDraggables().forEach(el => el.classList.remove('drag-over'));
                    draggedElement = null;
                    draggedData = null;
                };

                // Drag over handler
                const handleDragOver = (e) => {
                    e.preventDefault();
                    const target = e.target.closest('.xi-player-slot, .bench-player-slot');
                    if (target && target !== draggedElement) {
                        e.dataTransfer.dropEffect = 'move';
                        target.classList.add('drag-over');
                    }
                };

                // Drag leave handler
                const handleDragLeave = (e) => {
                    const target = e.target.closest('.xi-player-slot, .bench-player-slot');
                    if (target) {
                        target.classList.remove('drag-over');
                    }
                };

                // Drop handler
                const handleDrop = (e) => {
                    e.preventDefault();
                    const target = e.target.closest('.xi-player-slot, .bench-player-slot');

                    if (!target || !draggedElement || target === draggedElement) return;

                    target.classList.remove('drag-over');

                    // Perform the swap
                    swapPlayers(draggedElement, target);

                    // Reinitialize tooltips for bench players
                    reinitializeTooltips();
                };

                // Attach event listeners to all draggable elements
                getAllDraggables().forEach(el => {
                    el.addEventListener('dragstart', handleDragStart);
                    el.addEventListener('dragend', handleDragEnd);
                    el.addEventListener('dragover', handleDragOver);
                    el.addEventListener('dragleave', handleDragLeave);
                    el.addEventListener('drop', handleDrop);
                });
            });
        }
    });
</script>
{% endif %}

{% endblock %}